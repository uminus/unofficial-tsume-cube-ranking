<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Unofficial 詰めキューブ Ranking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  <style>
      img {
          border-radius: 50%;
      }

      .badge {
          font-size: 0.8rem;
      }
  </style>
</head>
<body>
<main class="container">
  <h1>Unofficial 詰めキューブ Ranking</h1>

  <form class="row g-2">
    <div class="col-auto row g-2">
      <select id="te" class="form-select" autocomplete="off">
        <option value="-1" selected>すべて</option>
        <option value="2">2手</option>
        <option value="3">3手</option>
        <option value="4">4手</option>
        <option value="5">5手</option>
        <option value="6">6手</option>
        <option value="7">7手</option>
        <option value="8">8手</option>
      </select>
    </div>
    <div class="col-auto" style="padding-top: 12px;">
      <input class="form-check-input" type="checkbox" value="" id="is_virtual" autocomplete="off">
      <label class="form-check-label" for="is_virtual"> Virtual Mode</label>
    </div>
  </form>

  <section id="list" class="container"></section>
</main>
<footer class="footer mt-auto py-3 bg-light fixed-bottom ">
  <div class="container">
    <div class="row">
      <a class="btn btn-outline-primary col-4" href="https://uesyuu.github.io/tsume_cube/">詰めキューブ(@uesyuu_cube)</a>
      <p id="updated_at" class="col-8 text-muted fs-6 text-end">ranking updated at:</p>
    </div>
  </div>
</footer>
<script>
    const regexTime = /((?<m>\d+):)?(?<s>\d+)\.(?<ms>\d+)/;

    let isVirtual = false;
    let te = -1;

    const checkboxIsVirtual = document.getElementById("is_virtual");
    checkboxIsVirtual.addEventListener("change", (ev) => {
        isVirtual = ev.target.checked;
        updateDOM();
    });

    const selectTe = document.getElementById("te");
    selectTe.addEventListener("change", (ev) => {
        te = parseInt(ev.target.value);
        updateDOM();
    });


    let users;
    let solves;
    Promise.all([
        fetch("./solves.json").then(res => res.json()),
        fetch("./users.json").then(res => res.json())
            .then(json => {
                return json.users.reduce((acc, u) => {
                    acc[u.id] = u;
                    return acc;
                }, {})
            }),
        fetch("./updated_at").then(res => res.text())
    ])
        .then(json => {
            solves = json[0];
            users = json[1];
            const updated_at = json[2]
            const timestamp = document.getElementById("updated_at");
            timestamp.innerText = `updated at: ${updated_at}`;

            updateDOM();
        })
        .catch(e => {
            const error = document.createElement("span");
            error.innerText = e.message;
            document.body.append(error);
        });

    function updateDOM() {
        console.log({isVirtual, te});

        let container = document.getElementById("solves");
        if (!container) {
            container = document.createElement("div");
            container.id = "solves";
            document.getElementById("list").append(container);
        }

        while (container.firstChild) {
            container.removeChild(container.lastChild);
        }

        solves.solves
            .filter(datum => (datum.te === te || te === -1) && datum.is_virtual === isVirtual)
            .map(datum => {
                if (!datum.time_millis) {
                    const t = datum.time.match(regexTime).groups;
                    datum.time_millis = parseInt(t.m || 0) * 60000 + parseInt(t.s) * 1000 + parseInt(t.ms);
                }
                return datum;
            })
            .sort((a, b) => a.time_millis - b.time_millis)
            .forEach((datum, i) => {
                const user = users[datum.author_id];
                const fragment = document.createDocumentFragment();
                const card = document.createElement("div");
                card.className = "card";
                fragment.append(card);

                const cardBody = document.createElement("div");
                cardBody.className = "card-body";
                card.append(cardBody);

                const cardTitle = document.createElement("h5");
                cardTitle.className = "card-title";

                const userIcon = document.createElement("img");
                userIcon.src = user.profile_image_url;
                cardTitle.append(userIcon);

                const userName = document.createElement("span");
                userName.textContent = `${user.name} ${datum.time}`;
                userName.style.paddingLeft = "8px";
                cardTitle.append(userName);
                cardBody.append(cardTitle);

                const badgeTe = document.createElement("span");
                badgeTe.className = "badge bg-primary";
                badgeTe.textContent = "" + datum.te;
                cardTitle.append(badgeTe);

                if (datum.is_virtual) {
                    const badgeVirtual = document.createElement("span");
                    badgeVirtual.className = "badge bg-success";
                    badgeVirtual.textContent = "Virtual";
                    cardTitle.append(badgeVirtual);
                }

                const cardSubTitle = document.createElement("h6");
                cardSubTitle.className = "card-subtitle mb-2 text-muted";
                cardSubTitle.textContent = `@${user.username}`;
                cardBody.append(cardSubTitle);

                const cardText = document.createElement("p");
                cardText.className = "card-text";
                cardText.textContent = datum.comment;
                cardBody.append(cardText);

                container.append(fragment);
            });
    }
</script>
</body>
</html>